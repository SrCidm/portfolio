---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { type Language } from '../i18n';

interface Props {
  title: string;
  description?: string;
  lang?: Language;
}

const { 
  title, 
  description = 'Sergio Cid - Full-Stack Developer specializing in React, Next.js, and modern web technologies.',
  lang = 'en'
} = Astro.props;
---

<!DOCTYPE html>
<html lang={lang} class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="author" content="Sergio Cid" />
    
    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content={lang === 'es' ? 'es_ES' : 'en_US'} />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    
    <title>{title}</title>
    
    <!-- Theme Script (prevent flash) -->
    <script is:inline>
      const theme = localStorage.getItem('theme') || 'dark';
      document.documentElement.classList.toggle('light', theme === 'light');
      document.documentElement.classList.toggle('dark', theme === 'dark');
    </script>
  </head>

  <body class="min-h-screen flex flex-col">
    <Header lang={lang} />
    
    <main class="flex-1">
      <slot />
    </main>
    
    <Footer lang={lang} />
    
    <!-- Theme Toggle Script con View Transitions -->
    <script>
      function setTheme(theme: 'dark' | 'light') {
        localStorage.setItem('theme', theme);
        document.documentElement.classList.toggle('light', theme === 'light');
        document.documentElement.classList.toggle('dark', theme === 'dark');
      }

      document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.getElementById('theme-toggle');
        
        themeToggle?.addEventListener('click', (event) => {
          const current = localStorage.getItem('theme') || 'dark';
          const newTheme = current === 'dark' ? 'light' : 'dark';
          
          // Si el navegador soporta View Transitions
          if (document.startViewTransition) {
            // Obtener posici贸n del bot贸n
            const button = event.currentTarget as HTMLElement;
            const rect = button.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            
            // Guardar las coordenadas en variables CSS
            document.documentElement.style.setProperty('--circle-x', `${x}px`);
            document.documentElement.style.setProperty('--circle-y', `${y}px`);
            
            document.startViewTransition(() => {
              setTheme(newTheme);
            });
          } else {
            // Sin efecto para navegadores antiguos
            setTheme(newTheme);
          }
        });
      });
    </script>

    <!-- Scroll Reveal Script -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const revealElements = document.querySelectorAll('.scroll-reveal, .scroll-reveal-left, .scroll-reveal-right, .scroll-reveal-scale');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('revealed');
            }
          });
        }, {
          threshold: 0.1,
          rootMargin: '0px 0px -50px 0px'
        });

        revealElements.forEach(el => observer.observe(el));
      });
    </script>

    <!-- Project Filter from Skills Script -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Check if there's a filter to apply from skill links
        const filterToApply = sessionStorage.getItem('projectFilter');
        
        if (filterToApply) {
          // Wait a bit for the page to fully load and scroll to complete
          setTimeout(() => {
            const filterBtn = document.querySelector(`[data-filter="${filterToApply}"]`) as HTMLButtonElement;
            if (filterBtn) {
              filterBtn.click();
            }
            sessionStorage.removeItem('projectFilter');
          }, 500);
        }
      });
    </script>
  </body>

  <style>
    /* Timing functions para animaci贸n suave */
    :root {
      --expo-out: linear(
        0 0%, 0.1684 2.66%, 0.3165 5.49%, 0.446 8.52%, 0.5581 11.78%, 0.6535 15.29%, 
        0.7341 19.11%, 0.8011 23.3%, 0.8557 27.93%, 0.8962 32.68%, 0.9283 38.01%, 
        0.9529 44.08%, 0.9711 51.14%, 0.9833 59.06%, 0.9915 68.74%, 1 100%
      );
    }

    /* View Transitions API - Circle Reveal desde bot贸n arriba a la derecha */
    ::view-transition-group(root) {
      animation-timing-function: var(--expo-out);
    }

    ::view-transition-old(root) {
      animation: none;
      animation-fill-mode: both;
      z-index: -1;
    }

    ::view-transition-new(root) {
      mask: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><defs><filter id="blur"><feGaussianBlur stdDeviation="2"/></filter></defs><circle cx="35" cy="5" r="18" fill="white" filter="url(%23blur)"/></svg>') top right / 0 no-repeat;
      animation: scaleCircle 1s;
      animation-fill-mode: both;
    }

    .dark::view-transition-new(root) {
      animation: scaleCircle 1s;
      animation-fill-mode: both;
    }

    @keyframes scaleCircle {
      to {
        mask-size: 200vmax;
      }
    }
  </style>
</html>
